<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="naver-site-verification" content="313dfe00aab244c26bd3a1ee6f1b52d3c3a430a1" />
    <meta name="description" content="Kyber Widget" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@kybernetwork" />
    <meta name="twitter:title" content="Kyber Widget" />
    <meta name="twitter:description" content="Kyber Widget" />
    <meta name="twitter:image" content="kyber-payment.png" />

    <!-- Schema.org markup for Google+ -->
    <meta itemprop="name" content="Kyber Widget">
    <meta itemprop="description" content="Kyber Widget">
    <meta itemprop="image" content="kyber-payment.png">

    <!-- Open Graph data -->
    <meta property="og:title" content="Kyber Widget" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://kyber.network/" />
    <meta property="og:image" content="kyber-payment.png" />
    <meta property="og:description" content="Kyber Widget" />
    <meta property="og:site_name" content="Kyber Widget" />
    <meta property="fb:admins" content="100000020906766" />
    <meta property="fb:app_id" content="509086899486057">
    <meta name="google-site-verification" content="LxmpNKWPfqNhxHkaWUpd5DU2hPX1cPrIqNNEvmYlzRI" />

    <title>Kyber Network</title>

    <link rel="shortcut icon" href="favicon.png" type="image/png">

    <!-- <link rel="stylesheet" href="foundation-float.min.css">
    <link rel="stylesheet" href="foundation-prototype.min.css"> -->

    <!-- <link rel="stylesheet" href="widget.css">
  <script type="text/javascript" src="widget.js"></script> -->

    <link rel="shortcut icon" href="favicon.png">
    <link href="https://dev-widget.knstats.com/wrapper/app.bundle.css?v=1538453945556" rel="stylesheet">
    <!-- <link href="http://localhost:3002/app.bundle.css?v=1538453945553" rel="stylesheet"> -->
</head>

<body class="notranslate">
    <div id="kyber-widget" class="kyber_widget"></div>

    <style>
        html body {
            background-color: #F8F8F8;
        }

        #kyber-widget #exchange {
            /* box-shadow: 0 2px 8px 0 hsla(0,0%,72%,.5); */
        }

        #kyber-widget .step-breadcrumb {
            border-left: 1px solid #eee;
            border-right: 1px solid #eee;
        }
    </style>
    <script type="text/javascript" src="https://dev-widget.knstats.com/wrapper/app.min.js?v=1538453945556"></script>
    <!-- <script type="text/javascript" src="http://localhost:3002/app.min.js?v=1538453945553"></script> -->
    

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
    <script>
        var config = {
            rinkeby: {
                url: 'https://rinkeby.infura.io/DtzEYY0Km2BA3YwyJcBG',
                kyber_network: '0x39CC6802cF1625C30548B57D885932CB381EB4a4',
                wrapper: '0xf1f149ee80118c909d970b5cd39a11b2d5498c6e'
            },
            mainnet: {
                url: 'https://mainnet.infura.io',
                kyber_network: '0x39CC6802cF1625C30548B57D885932CB381EB4a4',
                wrapper: '0xffa4bee0b9cd2c2e4eacb8d8f11096baa3e6c55d'
            },
            ropsten: {
                url: 'https://ropsten.infura.io/DtzEYY0Km2BA3YwyJcBG',
                kyber_network: '0x818E6FECD516Ecc3849DAf6845e3EC868087B755',
                wrapper: '0xae9ac1cdcef0068b1af1c1531da69fc01c0cfdc9',
                saleAddr: '0xe925c0aaafc8ed136c5563b1114273811da75ddf'
            }
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function getParams() {
            var network = getParameterByName('network')
           // var saleAddr = getParameterByName('saleAddr')
            return { network }
        }
        window.onload = function () {
            console.log("daonomic")
            var params = getParams()
            var configData = config[params.network]
            var url = configData.url
            //console.log(url)
            var web3 = new Web3(new Web3.providers.HttpProvider(url, 3000));
            //console.log(web3)
            var WRAPPER_ABI = [{"constant":true,"inputs":[{"name":"_sale","type":"address"}],"name":"getETHPrice","outputs":[{"name":"ethPrice","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_kyberProxy","type":"address"},{"name":"_sale","type":"address"},{"name":"token","type":"address"},{"name":"tokenQty","type":"uint256"},{"name":"maxDestQty","type":"uint256"},{"name":"minRate","type":"uint256"},{"name":"walletId","type":"address"}],"name":"tradeAndBuy","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_kyberProxy","type":"address"},{"name":"_sale","type":"address"},{"name":"token","type":"address"}],"name":"getTokenRate","outputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"sender","type":"address"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"ETHReceived","type":"event"}]
            var wapperContract = new web3.eth.Contract(WRAPPER_ABI, configData.wrapper)

            // var SALE_ABI = []
            // var saleContract = new web3.eth.Contract(ETHEREMON_ABI, configData.sale_address)

            window.kyberWidgetInstance.render({
                appId: "kyber-widget",
                wrapper: configData.wrapper,
                getPrice: function () {
                    //var params = getParams()
                    return new Promise((resolve, reject) => {
                        wapperContract.methods.getETHPrice(configData.saleAddr).call()
                            .then(result => {
                                var ethPrice = result
                                resolve(ethPrice)
                            }).catch(e => {
                                console.log(e)
                                reject(e)
                            })
                    })

                },
                getTxData: function (sourceToken, sourceAmount, maxDestAmount, minConversionRate, walletId) {
                    console.log(minConversionRate)
                    if (!web3.utils.isAddress(walletId)) {
                        walletId = "0x" + Array(41).join("0")
                    }
                    var data = wapperContract.methods.tradeAndBuy(
                        configData.kyber_network,
                        configData.saleAddr,
                        sourceToken,
                        sourceAmount,
                        maxDestAmount,
                        minConversionRate,
                        walletId).encodeABI()

                    return new Promise((resolve, reject) => {
                        resolve({ value: 0, data, gasLimit: 800000, to: configData.wrapper })
                    })
                }
            })
        }
    </script>
</body>

</html>
