<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="naver-site-verification" content="313dfe00aab244c26bd3a1ee6f1b52d3c3a430a1" />
    <meta name="description" content="Kyber Widget" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@kybernetwork" />
    <meta name="twitter:title" content="Kyber Widget" />
    <meta name="twitter:description" content="Kyber Widget" />
    <meta name="twitter:image" content="kyber-payment.png" />

    <!-- Schema.org markup for Google+ -->
    <meta itemprop="name" content="Kyber Widget">
    <meta itemprop="description" content="Kyber Widget">
    <meta itemprop="image" content="kyber-payment.png">

    <!-- Open Graph data -->
    <meta property="og:title" content="Kyber Widget" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://kyber.network/" />
    <meta property="og:image" content="kyber-payment.png" />
    <meta property="og:description" content="Kyber Widget" />
    <meta property="og:site_name" content="Kyber Widget" />
    <meta property="fb:admins" content="100000020906766" />
    <meta property="fb:app_id" content="509086899486057">
    <meta name="google-site-verification" content="LxmpNKWPfqNhxHkaWUpd5DU2hPX1cPrIqNNEvmYlzRI" />

    <title>Kyber Network</title>

    <link rel="shortcut icon" href="favicon.png" type="image/png">

    <!--<link href="https://widget.kyber.network/dapp-libs/v0.1/app.bundle.css?v=1538453945568" rel="stylesheet">-->
     <link href="http://localhost:3002/app.css" rel="stylesheet">
</head>

<body class="notranslate">
    <div id="kyber-widget" class="kyber_widget"></div>

    <!--<script type="text/javascript" src="https://widget.kyber.network/dapp-libs/v0.1/app.min.js?v=1538453945568"></script>-->
     <script type="text/javascript" src="http://localhost:3002/app.min.js"></script>
    

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.33/dist/web3.min.js"></script>
    <script>
        var config = {
            rinkeby: {
                url: 'https://rinkeby.infura.io/DtzEYY0Km2BA3YwyJcBG',
                kyber_network: '0x39CC6802cF1625C30548B57D885932CB381EB4a4',
                wrapper: '0xf1f149ee80118c909d970b5cd39a11b2d5498c6e'
            },
            mainnet: {
                url: 'https://mainnet.infura.io',
                kyber_network: '0x39CC6802cF1625C30548B57D885932CB381EB4a4',
                wrapper: '0xffa4bee0b9cd2c2e4eacb8d8f11096baa3e6c55d'
            },
            ropsten: {
                url: 'https://ropsten.infura.io/DtzEYY0Km2BA3YwyJcBG',
                kyber_network: '0x818E6FECD516Ecc3849DAf6845e3EC868087B755',
                wrapper: '0xae9ac1cdcef0068b1af1c1531da69fc01c0cfdc9',
                saleAddr: '0x5b0582823cd14b56070ddab7c6426930190d1bb0'
            }
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function getMultipleValuesByName(name) {
          let url = new URL(window.location.href);
          return url.searchParams.getAll(name);
        }

        function getProductsFromParam(productNames, productQtys = [], productImages = []) {
          return productNames.map((productName, index) => {
            const productQty = +productQtys[index] ? +productQtys[index] : 1;
            const productImage = productImages[index] ? productImages[index] : null;

            return { name: productName, qty: productQty, image: productImage };
          });
        }

        function verifyAccount(addr) {
          var valid = /^0x[0-9a-fA-F]{40}$/.test(addr)

          return valid ? null : "invalid"
        }

        function validateParams(commissionID, callback, signer, saleAddr, amount) {
          var errors = {};

          if (commissionID && verifyAccount(commissionID)) {
            errors["commissionID"] = "Commission address must be a valid ethereum address"
          }

          if (callback && !callback.startsWith("https://")) {
            errors["callback"] = "Callback must be a https location"
          }

          if (signer) {
            var invalidAddresses = []
            var addressArr = signer.split("_")

            addressArr.map(address => {
              if (verifyAccount(address)) {
                invalidAddresses.push(address)
              }
            });

            if (invalidAddresses.length > 0) {
              errors["signer"] = "Signer include invalid addresse"
            }
          }

          if (!saleAddr || verifyAccount(saleAddr)) {
                errors["saleAddr"] = "saleAddr is invalid addresses"
            }
            
        if (!amount){
            errors["amount"] = "Amount is invalid"
        }

          return errors;
        }

        function adjustNetwork(network) {
          switch (network) {
            case "production":
            case "mainnet":
            case "staging":
              return "mainnet";
            case "ropsten":
              return "ropsten";
            default:
              return "ropsten";
          }
        }

        function getAppParams() {
          const callback = getParameterByName('callback');
          const signer = getParameterByName('signer');
          const commissionId = getParameterByName('commissionId');
          const pinnedTokens = getParameterByName('pinnedTokens') || [];
          const saleAddr = getParameterByName('saleAddr');
          const receiveAmount = getParameterByName('amount');
          const theme = getParameterByName('theme');
          const receiveToken = getParameterByName('receiveToken') || 'ETH';
          const paymentData = getParameterByName('paymentData') || '';
          const hint = getParameterByName('hint');
          const productNames = getMultipleValuesByName("productName")
          const productQtys = getMultipleValuesByName("productQty")
          const productImages = getMultipleValuesByName("productImage")
          const products = productNames ? getProductsFromParam(productNames, productQtys, productImages) : [];
          let paramForwarding = getParameterByName('paramForwarding');
          let network = getParameterByName('network');
          const errors = validateParams(commissionId, callback, signer, saleAddr, receiveAmount);

          paramForwarding = paramForwarding === "true" || paramForwarding === true;
          network = adjustNetwork(network);

          return {
            products, network, errors , callback, paramForwarding, signer, receiveToken,
            commissionId, pinnedTokens, saleAddr, receiveAmount, theme, paymentData, hint
          }
        }

        window.onload = function () {
            var params = getAppParams()
            var configData = config[params.network]
            var url = configData.url
            var web3 = new Web3(new Web3.providers.HttpProvider(url, 3000));
            var WRAPPER_ABI = [{"constant":true,"inputs":[{"name":"_sale","type":"address"}],"name":"getETHPrice","outputs":[{"name":"ethPrice","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_kyberProxy","type":"address"},{"name":"_sale","type":"address"},{"name":"token","type":"address"},{"name":"tokenQty","type":"uint256"},{"name":"maxDestQty","type":"uint256"},{"name":"minRate","type":"uint256"},{"name":"walletId","type":"address"}],"name":"tradeAndBuy","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_kyberProxy","type":"address"},{"name":"_sale","type":"address"},{"name":"token","type":"address"}],"name":"getTokenRate","outputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"sender","type":"address"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"ETHReceived","type":"event"}]
            var wapperContract = new web3.eth.Contract(WRAPPER_ABI, configData.wrapper)

            window.kyberWidgetInstance.render({
                appId: "kyber-widget",
                wrapper: configData.wrapper,
                getPrice: function () {
                    return new Promise((resolve, reject) => {
                        var price = web3.utils.toWei(params.receiveAmount);
                        resolve(price.toString());
                    })

                },
                getTxData: function (sourceToken, sourceAmount, maxDestAmount, minConversionRate, walletId) {
                    if (!web3.utils.isAddress(walletId)) {
                        walletId = "0x" + Array(41).join("0")
                    }
                    var data = wapperContract.methods.tradeAndBuy(
                        configData.kyber_network,
                        params.saleAddr,
                        sourceToken,
                        sourceAmount,
                        maxDestAmount,
                        minConversionRate,
                        walletId).encodeABI()

                    return new Promise((resolve, reject) => {
                        resolve({ value: 0, data, gasLimit: 800000, to: configData.wrapper })
                    })
                },
                params,
                errors: params.errors
            })
        }
    </script>
</body>

</html>
